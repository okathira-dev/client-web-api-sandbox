# 源泉徴収票等オンライン化に関する仕様書の要求事項

## XML構造の基本

### 1. XML構造の構成要素

源泉徴収票等データは以下の構造を持つ：

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<?xml-stylesheet type="text/xsl" href="URL" ?>
<様式ID VR="バージョン" id="ID" page="ページ" sakuseiDay="作成日" sakuseiNM="作成者" softNM="ソフト名">
  （内容部分のXMLデータ）+
  <dsig:Signature xmlns:dsig="http://www.w3.org/2000/09/xmldsig#">
  </dsig:Signature>
</様式ID>
```

### 2. 様式ID要素の属性

- **VR（バージョン）**: XML構造設計書の様式のメジャーバージョン、マイナーバージョン。初期値は「1.0」
- **id**: 帳票個別部分を一意に特定するためのID。重複しないようにする必要がある
- **page**: 次葉または手続内複数帳票に対応。様式ID単位に「1」から付番
- **sakuseiDay（作成日）**: 作成日を「CCYY-MM-DD」の形式で持つ
- **sakuseiNM（作成者）**: 作成者の名前
- **softNM（ソフト名）**: 作成ソフト名

### 3. XML署名部分

- XML署名の種別はEnveloped署名
- 様式IDを署名範囲に指定
- XML署名要素内のReferenceタグのURI属性値は、「#id属性値」とする
- 一つの源泉徴収票等データに対して一つのXML署名を付けることができる
- 名前空間: `xmlns:dsig="http://www.w3.org/2000/09/xmldsig#"`

### 4. 名前空間

- 「kyotsu」はデフォルト名前空間定義とすること
- デフォルト名前空間：`http://xml.e-tax.nta.go.jp/XSD/kyotsu`
- 一般名前空間：`http://xml.e-tax.nta.go.jp/XSD/general`（`gen:`プレフィックス）

### 5. スタイルシート

- 国税庁が提供するスタイルシートのURL: `https://xml.e-tax.nta.go.jp/xsl/1.0/ファイル名`
- ファイル名は様式IDごとに異なる（例: TEG104 → CMTEG104-001.xsl）

## 仕様書の種類と役割

### 1. 共通ボキャブラリ（資料1）

- 帳票の様式に依存せず共通的に現れる記載項目の階層構造やデータ型
- 日付、住所、電話番号、氏名、金額など
- 各帳票で共通に用いられる要素や属性をモジュール化

### 2. XML構造設計書（資料2）

- 帳票単位のXML構造を定義
- レベル、要素内容、共通ボキャブラリ名またはデータ型、出現回数、属性、タグ名などを定義
- 項目を省略するときには、XMLタグごとに省略可能とする
- ただし、子階層が存在するとき、親階層の省略はできない

### 3. 帳票フィールド仕様書（資料3）

- 帳票の各項目に対する入力方法及び入力チェック条件を定義
- 入力支援項目: 入力型、繰り返し回数、書式等
- チェック項目: データ長、値の範囲、自動計算方法等

### 入力型の分類

- **文字型**: 直接入力、無編集
- **数値型**: 直接入力または自動計算、書式編集、無編集（マイナス変換）
- **区分型**: 選択、内容編集、コード編集

### 書式の記号

- **Z**: 数値ゼロサプレス有り
- **9**: 数値ゼロサプレス無し
- **0**: 0固定
- **-**: マイナス変換（入力: プラスの場合マイナスに変換、表示: マイナスを省いて表示）
- **,**: カンマ編集
- **.**: 小数点

## 様式IDと対応年分

様式IDは多数存在し、それぞれ対応する年分が異なる。主要な様式ID:

- TEG101～TEG108: 給与所得の源泉徴収票
- TEG202～TEG204: 特定口座年間取引報告書
- TEG300: 退職所得の源泉徴収票・特別徴収票
- TEG400～TEG408: 公的年金等の源泉徴収票
- TEG500～TEG501: オープン型証券投資信託収益の分配の支払通知書
- TEG600～TEG602: 配当等とみなす金額に関する支払通知書
- TEG700: 医療費通知(お知らせ)
- TEG800: 生命保険料控除証明書
- TEG810: 地震保険料控除証明書
- TEG820～TEG822: 寄附金受領証明書
- TEG830: 寄附金控除に関する証明書
- TEG840: 国民年金保険料等控除証明書
- TEG850: 小規模企業共済等掛金控除証明書
- TEG900: 住宅取得資金に係る借入金の年末残高等証明書

**注意**: 実際のkojoallフォルダには13個のTEGコード（TEG104, TEG105, TEG106, TEG107, TEG108, TEG800, TEG810, TEG820, TEG821, TEG822, TEG830, TEG840, TEG850）のCSVファイルのみが存在します。

## アーキテクチャへの影響

1. **XMLパーサー**: 様式ID要素の属性を正しく抽出できる必要がある
2. **表示コンポーネント**: ルート要素の属性（VR, id, page, sakuseiDay, sakuseiNM, softNM）を表示する機能が必要
3. **XML署名**: dsig:Signature要素を認識し、表示する機能が必要
4. **名前空間**: kyotsu名前空間の処理が必要
5. **スタイルシート**: XMLスタイルシート宣言の処理が必要（参考情報として）
